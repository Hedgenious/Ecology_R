

---
  title: "–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–±–ª—é–¥–µ–Ω–∏–π GBIF"
author: "Vampurr"
date: "`r Sys.Date()`"
output:
  html_document:
  toc: true
toc_float: true
theme: cerulean
toc_depth: 3
params:
  data_directory: "." # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–æ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width=9, fig.height=6)

# –ü–æ–ª—É—á–∞–µ–º –∏–º—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –æ—Ç—á–µ—Ç–∞
report_title <- paste("–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö GBIF –¥–ª—è:", basename(params$data_directory))

r report_title
üü¢ –≠–¢–ê–ü 1: –ó–ê–ì–†–£–ó–ö–ê –ü–ê–ö–ï–¢–û–í
cat("\nüü¢ [", Sys.Date(), "] –≠–¢–ê–ü 1: –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–∫–µ—Ç–æ–≤...\n")

# –ü–∞–∫–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–º —Å–∫—Ä–∏–ø—Ç–æ–º
library(tibble)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
IGNORE_WHEN_COPYING_START
content_copy
download
Use code with caution.
{r step-1-load-packages}
IGNORE_WHEN_COPYING_END
üü¢ –≠–¢–ê–ü 2: –£–°–¢–ê–ù–û–í–ö–ê –†–ê–ë–û–ß–ï–ô –î–ò–†–ï–ö–¢–û–†–ò–ò –ò –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
cat("\nüü¢ [", Sys.Date(), "] –≠–¢–ê–ü 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...\n")

# –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
WORK_DIR <- params$data_directory
setwd(WORK_DIR)
cat("–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:", getwd(), "\n")

rds_file <- file.path(WORK_DIR, "occurrence_data.rds")

if (!file.exists(rds_file)) {
  stop("–§–∞–π–ª occurrence_data.rds –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: ", WORK_DIR)
}

occurrence_data <- readRDS(rds_file)
occurrence_tbl <- as_tibble(occurrence_data)

cat("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫:", nrow(occurrence_tbl), "\n")
IGNORE_WHEN_COPYING_START
content_copy
download
Use code with caution.
{r step-2-load-data}
IGNORE_WHEN_COPYING_END
üü¢ –≠–¢–ê–ü 3: –ü–†–ï–û–ë–†–ê–ó–û–í–ê–ù–ò–ï –î–ê–ù–ù–´–•
cat("\nüü¢ [", Sys.Date(), "] –≠–¢–ê–ü 3: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...\n")

# –ü–æ–¥–≤—ã–±–æ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
# –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤ –ø–µ—Ä–µ–¥ –≤—ã–±–æ—Ä–æ–º
required_cols <- c("eventDate", "year", "month", "day", "decimalLatitude",
                   "decimalLongitude", "coordinateUncertaintyInMeters",
                   "genus", "specificEpithet", "scientificName", "speciesKey")
available_cols <- intersect(required_cols, colnames(occurrence_tbl))
missing_cols <- setdiff(required_cols, available_cols)
if (length(missing_cols) > 0) {
  cat("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å—Ç–æ–ª–±—Ü—ã:", paste(missing_cols, collapse=", "), "\n")
}

observations_subset <- occurrence_tbl %>%
  select(any_of(available_cols)) # –ò—Å–ø–æ–ª—å–∑—É–µ–º any_of –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö

# –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ eventDate –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ weekday, –µ—Å–ª–∏ —Å—Ç–æ–ª–±–µ—Ü –µ—Å—Ç—å
if ("eventDate" %in% colnames(observations_subset)) {
  observations_subset <- observations_subset %>%
    mutate(
      # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã
      eventDate_parsed = suppressWarnings(as.Date(eventDate, format = "%Y-%m-%d")),
      weekday = ifelse(!is.na(eventDate_parsed), weekdays(eventDate_parsed), NA)
    )
} else {
  cat("–°—Ç–æ–ª–±–µ—Ü eventDate –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –Ω–µ –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω.\n")
}

# –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
head(observations_subset)
IGNORE_WHEN_COPYING_START
content_copy
download
Use code with caution.
{r step-3-transform-data}
IGNORE_WHEN_COPYING_END
üü¢ –≠–¢–ê–ü 4: –†–ê–°–ß–Å–¢ –°–¢–ê–¢–ò–°–¢–ò–ö
cat("\nüü¢ [", Sys.Date(), "] –≠–¢–ê–ü 4: –†–∞—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–≤–æ–¥–æ–∫...\n")

# --- 1. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º ---
if ("scientificName" %in% colnames(observations_subset)) {
  species_count <- observations_subset %>%
    filter(!is.na(scientificName)) %>%
    group_by(scientificName) %>%
    summarise(observation_count = n(), .groups = 'drop') %>%
    arrange(desc(observation_count))
  cat("\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–∞:\n")
  print(head(species_count)) # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø
}

# --- 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ–¥–∞–º ---
if ("year" %in% colnames(observations_subset)) {
  year_summary <- observations_subset %>%
    filter(!is.na(year)) %>%
    group_by(year) %>%
    summarise(observation_count = n(), .groups = 'drop') %>%
    arrange(year)
  cat("\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ–¥–∞–º (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π):\n")
  print(year_summary, n = Inf) # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
}

# --- 3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º ---
if ("month" %in% colnames(observations_subset)) {
  month_summary <- observations_subset %>%
    filter(!is.na(month) & month >= 1 & month <= 12) %>% # –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –º–µ—Å—è—Ü–∞
    group_by(month) %>%
    summarise(observation_count = n(), .groups = 'drop') %>%
    arrange(month)
  cat("\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π):\n")
  print(month_summary)
}

# --- 4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º ---
if ("decimalLatitude" %in% colnames(observations_subset) && "decimalLongitude" %in% colnames(observations_subset)) {
  coordinates_stats <- observations_subset %>%
    summarise(
      min_latitude  = min(decimalLatitude, na.rm = TRUE),
      max_latitude  = max(decimalLatitude, na.rm = TRUE),
      min_longitude = min(decimalLongitude, na.rm = TRUE),
      max_longitude = max(decimalLongitude, na.rm = TRUE),
      .groups = 'drop'
    )
  cat("\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º:\n")
  print(coordinates_stats)
  
  # --- 5. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ ---
  observations_with_coords_count <- observations_subset %>%
    filter(!is.na(decimalLatitude) & !is.na(decimalLongitude)) %>%
    nrow()
  total_obs <- nrow(observations_subset)
  cat("\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏:", observations_with_coords_count, "\n")
  if (total_obs > 0) {
    cat("–ü—Ä–æ—Ü–µ–Ω—Ç –Ω–∞–±–ª—é–¥–µ–Ω–∏–π —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏:", round((observations_with_coords_count / total_obs) * 100, 2), "%\n")
  }
}

# --- 6. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–æ–¥–∞–º ---
if ("genus" %in% colnames(observations_subset)) {
  genus_summary <- observations_subset %>%
    filter(!is.na(genus)) %>%
    group_by(genus) %>%
    summarise(observation_count = n(), .groups = 'drop') %>%
    arrange(desc(observation_count))
  cat("\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–æ–¥–∞–º:\n")
  print(head(genus_summary))
}

# --- 7. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ---
if ("coordinateUncertaintyInMeters" %in% colnames(observations_subset)) {
  coordinate_uncertainty_stats <- observations_subset %>%
    summarise(
      mean_uncertainty   = mean(coordinateUncertaintyInMeters, na.rm = TRUE),
      median_uncertainty = median(coordinateUncertaintyInMeters, na.rm = TRUE),
      sd_uncertainty     = sd(coordinateUncertaintyInMeters, na.rm = TRUE),
      min_uncertainty    = min(coordinateUncertaintyInMeters, na.rm = TRUE),
      max_uncertainty    = max(coordinateUncertaintyInMeters, na.rm = TRUE),
      na_count           = sum(is.na(coordinateUncertaintyInMeters)),
      .groups = 'drop'
    )
  cat("\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (coordinateUncertaintyInMeters):\n")
  print(coordinate_uncertainty_stats)
  # print(summary(observations_subset$coordinateUncertaintyInMeters))
}

# --- 8. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ–≥–∏–æ–Ω—É (stateProvince) ---
if ("stateProvince" %in% colnames(occurrence_tbl)) {
  state_summary <- occurrence_tbl %>%
    filter(!is.na(stateProvince) & stateProvince != "") %>%
    group_by(stateProvince) %>%
    summarise(observation_count = n(), .groups = 'drop') %>%
    arrange(desc(observation_count))
  cat("\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —à—Ç–∞—Ç–∞–º/—Ä–µ–≥–∏–æ–Ω–∞–º (stateProvince):\n")
  print(state_summary, n = Inf)
}

# --- 9. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É –Ω–∞–±–ª—é–¥–µ–Ω–∏–π (occurrenceStatus) ---
if ("occurrenceStatus" %in% colnames(occurrence_tbl)) {
  occurrence_status_summary <- occurrence_tbl %>%
    group_by(occurrenceStatus) %>%
    summarise(observation_count = n(), .groups = 'drop') %>%
    arrange(desc(observation_count))
  cat("\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É –Ω–∞–±–ª—é–¥–µ–Ω–∏–π (occurrenceStatus):\n")
  print(occurrence_status_summary)
}

# --- 10. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ ---
if ("weekday" %in% colnames(observations_subset)) {
  weekday_summary <- observations_subset %>%
    filter(!is.na(weekday)) %>%
    group_by(weekday) %>%
    summarise(observation_count = n(), .groups = 'drop') %>%
    # –£–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–µ–º –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
    mutate(weekday = factor(weekday, levels = c("–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–≤—Ç–æ—Ä–Ω–∏–∫", "—Å—Ä–µ–¥–∞", "—á–µ—Ç–≤–µ—Ä–≥", "–ø—è—Ç–Ω–∏—Ü–∞", "—Å—É–±–±–æ—Ç–∞", "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ",
                                                "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))) %>%
    arrange(weekday)
  cat("\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏:\n")
  print(weekday_summary)
}

# --- 11. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–æ–≤ ---
if ("scientificName" %in% colnames(observations_subset)) {
  unique_species_count <- observations_subset %>%
    filter(!is.na(scientificName)) %>%
    distinct(scientificName) %>%
    nrow()
  cat("\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–æ–≤:", unique_species_count, "\n")
}
IGNORE_WHEN_COPYING_START
content_copy
download
Use code with caution.
{r step-4-stats}
IGNORE_WHEN_COPYING_END
üü¢ –≠–¢–ê–ü 5: –ü–û–°–¢–†–û–ï–ù–ò–ï –ì–†–ê–§–ò–ö–û–í
cat("\nüü¢ [", Sys.Date(), "] –≠–¢–ê–ü 5: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤...\n")

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–¥–∏–Ω—É—é —Ç–µ–º—É –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
theme_set(theme_classic() + theme(plot.title = element_text(hjust = 0.5)))

# --- 1. –¢–æ–ø-10 –≤–∏–¥–æ–≤ ---
if (exists("species_count") && nrow(species_count) > 0) {
  top_species <- species_count %>% slice_head(n = 10)
  p1 <- ggplot(top_species, aes(x = reorder(scientificName, observation_count), y = observation_count)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    coord_flip() +
    labs(title = "–¢–æ–ø 10 –≤–∏–¥–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –Ω–∞–±–ª—é–¥–µ–Ω–∏–π", x = "–ù–∞—É—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ", y = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π")
  print(p1)
}

# --- 2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –ø–æ –≥–æ–¥–∞–º ---
if (exists("year_summary") && nrow(year_summary) > 0) {
  p2 <- ggplot(year_summary, aes(x = as.factor(year), y = observation_count)) +
    geom_bar(stat = "identity", fill = "tomato") +
    labs(title = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –ø–æ –≥–æ–¥–∞–º", x = "–ì–æ–¥", y = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) # –ü–æ–≤–æ—Ä–æ—Ç –ø–æ–¥–ø–∏—Å–µ–π, –µ—Å–ª–∏ –∏—Ö –º–Ω–æ–≥–æ
  print(p2)
}

# --- 3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –ø–æ –º–µ—Å—è—Ü–∞–º ---
if (exists("month_summary") && nrow(month_summary) > 0) {
  p3 <- ggplot(month_summary, aes(x = factor(month, levels = 1:12), y = observation_count)) + # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø–æ—Ä—è–¥–æ–∫ –º–µ—Å—è—Ü–µ–≤
    geom_bar(stat = "identity", fill = "forestgreen") +
    labs(title = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –ø–æ –º–µ—Å—è—Ü–∞–º", x = "–ú–µ—Å—è—Ü", y = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π") +
    scale_x_discrete(labels = month.abb[1:12]) # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—ã –º–µ—Å—è—Ü–µ–≤
  print(p3)
}

# --- 4. –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π (—Ç–æ—á–∫–∏) ---
if (exists("observations_with_coords_count") && observations_with_coords_count > 0) {
  observations_coords_sf <- observations_subset %>%
    filter(!is.na(decimalLatitude) & !is.na(decimalLongitude)) %>%
    st_as_sf(coords = c("decimalLongitude", "decimalLatitude"), crs = 4326) # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ sf –æ–±—ä–µ–∫—Ç
  
  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Ä—Ç—É –º–∏—Ä–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  world <- ne_countries(scale = "medium", returnclass = "sf")
  
  # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ —Ç–æ—á–∫–∞–º –¥–∞–Ω–Ω—ã—Ö
  bbox_data <- st_bbox(observations_coords_sf)
  
  # –†–∞—Å—à–∏—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
  expand_factor = 0.1 # 10% —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
  xlim_dynamic = c(bbox_data$xmin - (bbox_data$xmax - bbox_data$xmin) * expand_factor,
                   bbox_data$xmax + (bbox_data$xmax - bbox_data$xmin) * expand_factor)
  ylim_dynamic = c(bbox_data$ymin - (bbox_data$ymax - bbox_data$ymin) * expand_factor,
                   bbox_data$ymax + (bbox_data$ymax - bbox_data$ymin) * expand_factor)
  
  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —Ä–∞–∑—É–º–Ω—ã–º–∏ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —à–∏—Ä–æ—Ç—ã/–¥–æ–ª–≥–æ—Ç—ã
  xlim_dynamic[1] <- max(xlim_dynamic[1], -180)
  xlim_dynamic[2] <- min(xlim_dynamic[2], 180)
  ylim_dynamic[1] <- max(ylim_dynamic[1], -90)
  ylim_dynamic[2] <- min(ylim_dynamic[2], 90)
  
  
  p4 <- ggplot() +
    geom_sf(data = world, fill = "gray85", color = "white", size = 0.2) + # –ö–∞—Ä—Ç–∞ –º–∏—Ä–∞ —Ñ–æ–Ω–æ–º
    geom_sf(data = observations_coords_sf, color = "purple", alpha = 0.5, size = 1) + # –¢–æ—á–∫–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
    coord_sf(xlim = xlim_dynamic, ylim = ylim_dynamic, expand = FALSE) + # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã
    labs(title = "–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π", x = "–î–æ–ª–≥–æ—Ç–∞", y = "–®–∏—Ä–æ—Ç–∞")
  print(p4)
} else {
  cat ("\n–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫–∞—Ä—Ç—ã —Ç–æ—á–µ–∫.\n")
}


# --- 5. –¢–æ–ø-10 —Ä–æ–¥–æ–≤ ---
if (exists("genus_summary") && nrow(genus_summary) > 0) {
  top_genus <- genus_summary %>% slice_head(n = 10)
  p5 <- ggplot(top_genus, aes(x = reorder(genus, observation_count), y = observation_count)) +
    geom_bar(stat = "identity", fill = "orange") +
    coord_flip() +
    labs(title = "–¢–æ–ø 10 —Ä–æ–¥–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –Ω–∞–±–ª—é–¥–µ–Ω–∏–π", x = "–†–æ–¥", y = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π")
  print(p5)
}

# --- 6. –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ---
if (exists("coordinate_uncertainty_stats") && !is.na(coordinate_uncertainty_stats$median_uncertainty)) {
  # –û–≥—Ä–∞–Ω–∏—á–∏–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ 10 –∫–º, –∏ –ø–æ–∫–∞–∂–µ–º –≤—ã–±—Ä–æ—Å—ã –æ—Ç–¥–µ–ª—å–Ω–æ
  uncertainty_subset <- observations_subset %>%
    filter(!is.na(coordinateUncertaintyInMeters))
  
  max_uncertainty_plot <- min(max(uncertainty_subset$coordinateUncertaintyInMeters, na.rm=TRUE), 10000) # –û–≥—Ä–∞–Ω–∏—á–∏–º 10–∫–º
  
  p6 <- ggplot(uncertainty_subset, aes(x = coordinateUncertaintyInMeters)) +
    geom_histogram(binwidth = max_uncertainty_plot / 50, fill = "cyan", color = "black") + # 50 –±–∏–Ω–æ–≤
    scale_x_continuous(limits = c(0, max_uncertainty_plot)) + # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ—Å—å X
    labs(title = paste("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–¥–æ", max_uncertainty_plot, "–º)"),
         x = "–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–º)", y = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π")
  print(p6)
  
  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: —Å–∫–æ–ª—å–∫–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –∏–º–µ—é—Ç –±–æ–ª—å—à—É—é –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å?
  high_uncertainty_count <- uncertainty_subset %>%
    filter(coordinateUncertaintyInMeters > max_uncertainty_plot) %>% nrow()
  if (high_uncertainty_count > 0) {
    cat("\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π —Å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç >", max_uncertainty_plot, "–º:", high_uncertainty_count, "\n")
  }
  
}

# --- 7. –ù–∞–±–ª—é–¥–µ–Ω–∏—è –ø–æ —à—Ç–∞—Ç–∞–º/—Ä–µ–≥–∏–æ–Ω–∞–º ---
if (exists("state_summary") && nrow(state_summary) > 0) {
  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø N —Ä–µ–≥–∏–æ–Ω–æ–≤, –µ—Å–ª–∏ –∏—Ö –º–Ω–æ–≥–æ
  top_n_states <- min(nrow(state_summary), 20)
  state_summary_top <- state_summary %>% slice_head(n = top_n_states)
  
  p7 <- ggplot(state_summary_top, aes(x = reorder(stateProvince, observation_count), y = observation_count)) +
    geom_bar(stat = "identity", fill = "skyblue") +
    coord_flip() +
    labs(title = paste("–¢–æ–ø", top_n_states, "—Ä–µ–≥–∏–æ–Ω–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –Ω–∞–±–ª—é–¥–µ–Ω–∏–π"),
         x = "–®—Ç–∞—Ç/–†–µ–≥–∏–æ–Ω", y = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π")
  print(p7)
}

# --- 8. –°—Ç–∞—Ç—É—Å –Ω–∞–±–ª—é–¥–µ–Ω–∏–π ---
if (exists("occurrence_status_summary") && nrow(occurrence_status_summary) > 0) {
  p8 <- ggplot(occurrence_status_summary, aes(x = reorder(occurrenceStatus, observation_count), y = observation_count)) +
    geom_bar(stat = "identity", fill = "pink") +
    coord_flip() +
    labs(title = "–°—Ç–∞—Ç—É—Å –Ω–∞–±–ª—é–¥–µ–Ω–∏–π", x = "–°—Ç–∞—Ç—É—Å", y = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π")
  print(p8)
}

# --- 9. –ù–∞–±–ª—é–¥–µ–Ω–∏—è –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ ---
if (exists("weekday_summary") && nrow(weekday_summary) > 0) {
  p9 <- ggplot(weekday_summary, aes(x = weekday, y = observation_count)) +
    geom_bar(stat = "identity", fill = "magenta") +
    labs(title = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏", x = "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏", y = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  print(p9)
}
IGNORE_WHEN_COPYING_START
content_copy
download
Use code with caution.
{r step-5-plots}
IGNORE_WHEN_COPYING_END
üü¢ –≠–¢–ê–ü 6: –ü–û–°–¢–†–û–ï–ù–ò–ï –ö–ê–†–¢–´ –ù–ê–ë–õ–Æ–î–ï–ù–ò–ô (–ï–°–õ–ò –ö–ê–ó–ê–•–°–¢–ê–ù)
cat("\nüü¢ [", Sys.Date(), "] –≠–¢–ê–ü 6: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –Ω–∞–±–ª—é–¥–µ–Ω–∏–π (–ø—Ä–∏–º–µ—Ä –¥–ª—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞)...\n")

# –≠—Ç–æ—Ç –±–ª–æ–∫ –º–æ–∂–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å —É—Å–ª–æ–≤–Ω—ã–º, –µ—Å–ª–∏ –∞–Ω–∞–ª–∏–∑ –Ω–µ –≤—Å–µ–≥–¥–∞ –ø–æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—É

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
if (exists("observations_with_coords_count") && observations_with_coords_count > 0) {
  observations_coords_sf <- observations_subset %>%
    filter(!is.na(decimalLatitude) & !is.na(decimalLongitude)) %>%
    st_as_sf(coords = c("decimalLongitude", "decimalLatitude"), crs = 4326)
  
  # –ü–æ–ø—Ä–æ–±—É–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω–∞—Ö–æ–¥—è—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∏ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ
  kazakhstan <- ne_countries(country = "Kazakhstan", scale = "medium", returnclass = "sf")
  kaz_bbox <- st_bbox(kazakhstan)
  
  # –ü—Ä–æ–≤–µ—Ä–∏–º, –ø–æ–ø–∞–¥–∞—é—Ç –ª–∏ —Ç–æ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –≥—Ä–∞–Ω–∏—Ü—ã –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
  points_in_kaz <- observations_coords_sf %>%
    filter(
      st_coordinates(geometry)[,1] >= kaz_bbox$xmin & st_coordinates(geometry)[,1] <= kaz_bbox$xmax &
        st_coordinates(geometry)[,2] >= kaz_bbox$ymin & st_coordinates(geometry)[,2] <= kaz_bbox$ymax
    )
  
  # –ï—Å–ª–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Ç–æ—á–µ–∫ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ, —Å—Ç—Ä–æ–∏–º –∫–∞—Ä—Ç—É –¥–ª—è –Ω–µ–≥–æ
  # –ü–æ—Ä–æ–≥ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä > 50% —Ç–æ—á–µ–∫ –∏–ª–∏ > 10 —Ç–æ—á–µ–∫
  if (nrow(points_in_kaz) > 10 || (nrow(observations_coords_sf) > 0 && nrow(points_in_kaz) / nrow(observations_coords_sf) > 0.5) ) {
    cat("–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –¥–ª—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞...\n")
    map_kaz <- ggplot() +
      geom_sf(data = kazakhstan, fill = "lightblue", color = "black", size = 0.3) +
      geom_sf(
        data = observations_coords_sf, # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ —Ç–æ—á–∫–∏, –Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º—Å—è –Ω–∞ –ö–ó
        color = "red3", alpha = 0.6, size = 1.5
      ) +
      labs(title = "–ö–∞—Ä—Ç–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π (—Ñ–æ–∫—É—Å –Ω–∞ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ)", x = "–î–æ–ª–≥–æ—Ç–∞", y = "–®–∏—Ä–æ—Ç–∞") +
      # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ö–ó –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–µ–¥–µ–ª–æ–≤ –∫–∞—Ä—Ç—ã
      coord_sf(
        xlim = c(kaz_bbox$xmin, kaz_bbox$xmax),
        ylim = c(kaz_bbox$ymin, kaz_bbox$ymax),
        expand = TRUE # –ù–µ–º–Ω–æ–≥–æ —Ä–∞—Å—à–∏—Ä–∏–º –≥—Ä–∞–Ω–∏—Ü—ã
      ) +
      theme_classic() +
      theme(plot.title = element_text(hjust = 0.5))
    print(map_kaz)
  } else {
    cat("–ù–∞–±–ª—é–¥–µ–Ω–∏—è, –ø–æ—Ö–æ–∂–µ, –Ω–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—É. –ü—Ä–æ–ø—É—Å–∫ –∫–∞—Ä—Ç—ã –ö–ó.\n")
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ–±—â–µ–π –∫–∞—Ä—Ç—ã –º–∏—Ä–∞, –µ—Å–ª–∏ –∫–∞—Ä—Ç–∞ –ö–ó –Ω–µ —Å—Ç—Ä–æ–∏—Ç—Å—è (–∫–∞–∫ –≤ —à–∞–≥–µ 5, –≥—Ä–∞—Ñ–∏–∫ 4)
    if (!exists("p4")) { # –ï—Å–ª–∏ –æ–±—â–∞—è –∫–∞—Ä—Ç–∞ –µ—â–µ –Ω–µ –±—ã–ª–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞
      world <- ne_countries(scale = "medium", returnclass = "sf")
      bbox_data <- st_bbox(observations_coords_sf)
      expand_factor = 0.1
      xlim_dynamic = c(bbox_data$xmin - (bbox_data$xmax - bbox_data$xmin) * expand_factor, bbox_data$xmax + (bbox_data$xmax - bbox_data$xmin) * expand_factor)
      ylim_dynamic = c(bbox_data$ymin - (bbox_data$ymax - bbox_data$ymin) * expand_factor, bbox_data$ymax + (bbox_data$ymax - bbox_data$ymin) * expand_factor)
      xlim_dynamic[1] <- max(xlim_dynamic[1], -180); xlim_dynamic[2] <- min(xlim_dynamic[2], 180)
      ylim_dynamic[1] <- max(ylim_dynamic[1], -90); ylim_dynamic[2] <- min(ylim_dynamic[2], 90)
      
      p4_fallback <- ggplot() +
        geom_sf(data = world, fill = "gray85", color = "white", size = 0.2) +
        geom_sf(data = observations_coords_sf, color = "purple", alpha = 0.5, size = 1) +
        coord_sf(xlim = xlim_dynamic, ylim = ylim_dynamic, expand = FALSE) +
        labs(title = "–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π (–û–±—â–∞—è –∫–∞—Ä—Ç–∞)", x = "–î–æ–ª–≥–æ—Ç–∞", y = "–®–∏—Ä–æ—Ç–∞")
      print(p4_fallback)
    }
  }
} else {
  cat("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.\n")
}
IGNORE_WHEN_COPYING_START
content_copy
download
Use code with caution.
{r step-6-map-kaz}
IGNORE_WHEN_COPYING_END
‚úÖ –ó–ê–í–ï–†–®–ï–ù–ò–ï –û–¢–ß–ï–¢–ê
cat("\n‚úÖ [", Sys.Date(), "] –û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:", basename(params$data_directory), "\n")
IGNORE_WHEN_COPYING_START
content_copy
download
Use code with caution.
{r step-7-end}
IGNORE_WHEN_COPYING_END

