# ============================================================
# üü¢ –û–°–ù–û–í–ù–û–ô –°–ö–†–ò–ü–¢: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–ø–æ–∫ GBIF –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤
# ============================================================
cat("\nüü¢ [", Sys.Date(), "] –ó–ê–ü–£–°–ö –û–°–ù–û–í–ù–û–ì–û –°–ö–†–ò–ü–¢–ê\n")

# --- 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ---
cat("--- –≠—Ç–∞–ø 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ---\n")

# –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–ø–∫–µ —Å –ø–æ–¥–ø–∞–ø–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö GBIF
MAIN_DIR <- "E:/R/Ecology_R/data/gbif/unzipped_data/"
# –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —à–∞–±–ª–æ–Ω–∞ R Markdown
RMD_TEMPLATE_FILE <- "E:/R/Ecology_R/lesson_7/lesson_7.Rmd" # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if (!dir.exists(MAIN_DIR)) {
  stop("–û—Å–Ω–æ–≤–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: ", MAIN_DIR)
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ —à–∞–±–ª–æ–Ω–∞
if (!file.exists(RMD_TEMPLATE_FILE)) {
  stop("–§–∞–π–ª —à–∞–±–ª–æ–Ω–∞ R Markdown –Ω–µ –Ω–∞–π–¥–µ–Ω: ", RMD_TEMPLATE_FILE)
}

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∞–ø–æ–∫ (–Ω–µ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ)
DIR_LIST <- list.dirs(MAIN_DIR, full.names = TRUE, recursive = FALSE)

if (length(DIR_LIST) == 0) {
  stop("–í —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–µ—Ç –ø–æ–¥–ø–∞–ø–æ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: ", MAIN_DIR)
}

cat("–ù–∞–π–¥–µ–Ω–æ –ø–∞–ø–æ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:", length(DIR_LIST), "\n")
# print(DIR_LIST) # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫

# --- 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ ---
cat("\n--- –≠—Ç–∞–ø 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ ---\n")

required_packages <- c("rmarkdown", "tibble", "readr", "dplyr", "tidyr",
                       "ggplot2", "rnaturalearth", "rnaturalearthdata", "sf")

for (pkg in required_packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    cat("–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞:", pkg, "\n")
    install.packages(pkg)
  }
  # library(pkg, character.only = TRUE) # –ó–∞–≥—Ä—É–∂–∞—Ç—å –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–¥–µ—Å—å, Rmd —Å–∞–º –∑–∞–≥—Ä—É–∑–∏—Ç
}
# –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ rmarkdown —Ç–æ—á–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ render
library(rmarkdown)
cat("–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã/—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.\n")


# --- 3. –¶–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–ø–æ–∫ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–æ–≤ ---
cat("\n--- –≠—Ç–∞–ø 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–ø–æ–∫ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ ---\n")

for (WORK_DIR in DIR_LIST) {
  cat("\n------------------------------------------------------------\n")
  cat("–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–ø–∫–∏:", basename(WORK_DIR), "\n")
  cat("–ü–æ–ª–Ω—ã–π –ø—É—Ç—å:", WORK_DIR, "\n")
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ rds —Ñ–∞–π–ª–∞ –≤ –ø–∞–ø–∫–µ
  rds_path <- file.path(WORK_DIR, "occurrence_data.rds")
  if (!file.exists(rds_path)) {
    cat("–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –§–∞–π–ª occurrence_data.rds –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–ø–∫–µ", basename(WORK_DIR), ". –ü—Ä–æ–ø—É—Å–∫ –ø–∞–ø–∫–∏.\n")
    next # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –ø–∞–ø–∫–µ
  }
  
  
  # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ HTML —Ñ–∞–π–ª–∞
  output_filename <- paste0("report_", basename(WORK_DIR), ".html")
  output_path <- file.path(WORK_DIR, output_filename) # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ç—É –∂–µ –ø–∞–ø–∫—É
  
  # –ò—Å–ø–æ–ª—å–∑—É–µ–º tryCatch –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤–æ –≤—Ä–µ–º—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
  tryCatch({
    cat("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞:", output_filename, "...\n")
    
    # –í—ã–∑–æ–≤ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ R Markdown
    rmarkdown::render(
      input = RMD_TEMPLATE_FILE,         # –ü—É—Ç—å –∫ —à–∞–±–ª–æ–Ω—É Rmd
      output_format = "html_document",   # –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞
      output_file = output_filename,     # –ò–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
      output_dir = WORK_DIR,             # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞
      params = list(
        data_directory = WORK_DIR        # –ü–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤ Rmd
      ),
      quiet = FALSE # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ TRUE, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –≤—ã–≤–æ–¥ pandoc
    )
    
    cat("‚úÖ –û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –¥–ª—è –ø–∞–ø–∫–∏:", basename(WORK_DIR), "\n")
    cat("   –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫:", output_path, "\n")
    
  }, error = function(e) {
    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –Ω–µ —É–¥–∞–ª—Å—è
    cat("\n‚ùå –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–∞–ø–∫–∏:", basename(WORK_DIR), "\n")
    cat("   –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ:", conditionMessage(e), "\n")
  }) # –ö–æ–Ω–µ—Ü tryCatch
  
} # –ö–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ for

# ============================================================
# ‚úÖ –ó–ê–í–ï–†–®–ï–ù–ò–ï –û–°–ù–û–í–ù–û–ì–û –°–ö–†–ò–ü–¢–ê
# ============================================================
cat("\n------------------------------------------------------------\n")
cat("‚úÖ [", Sys.Date(), "] –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É.\n")